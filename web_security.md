# 安全なWebサイトの作り方まとめ

IPA「安全なWebサイトの作り方」の個人的まとめ
link: https://www.ipa.go.jp/security/vuln/websecurity.html

---

## Webアプリケーションのセキュリティ実装

---

### SQLインジェクション

#### 概要

- SQL文の組み立てに問題がある場合の攻撃
- データベースの不正利用を招く可能性がある

#### 根本的解決

-  プレースホルダでSQL組み立てを実装する
    - アプリケーションで直接文字列連結処理は回避
    - SQLの雛形に変数のポインタを置き、実際の値をそこに割り当てる(バインド
    - 静的プレースホルダと動的プレースホルダがある
    - 静的の方だとSQLインジェクション自体がなくなる
- 文字列連結の場合はエスケープ処理でSQL文のリテラルを正しく構成
    - 数値型へのキャストや’\などの特殊記号文字をエスケープ
- アプリケーションに渡されるパラメータにSQL文を直接指定しない
    - hiddenパラメータにSQLをそのまま指定するなどは論外
    - パラメータの改変によりデータベースの不正利用がありうる

#### 保険的対策

- エラーメッセージをそのままブラウザに表示しない
    - SQLインジェクションのヒントになってしまう
- データベースアカウントへの適切な権限assign
    - 命令実行に必要な最低限の権限をアカウントに与える

---

### OSコマンド・インジェクション

#### 概要

- OSコマンドを含む攻撃によりサーバー上でOSコマンドが不正に実行される
- 重要情報の漏えいやシステム不正操作のほか、他の攻撃への踏み台にされうる

#### 根本的解決

- シェルを起動できる言語機能の利用を避ける
    - 外部からの入力値を引数にOSコマンドを実行できる機能(シェル起動)を避ける
    - Perlなどの場合sysopen関数を利用するなどでシェル起動を避ける

#### 保険的対策

- シェル起動を含む言語機能を利用する場合は引数をチェック
    - 入力されうる引数のホワイトリストを作る
    - 想定動作以外のコマンドを処理しない

---

### ディレクトリ・トラバーサル

#### 概要

- パラメータにサーバー内のファイル名を直接指定している問題
- 攻撃者によって任意のファイルを指定され意図しない処理が行われうる
- 公開を想定していないファイルが閲覧されうるなどの被害

#### 根本的解決

- 外部からのパラメータでサーバー内のファイルを直接指定しない
    - HTML上のhiddenパラメータでサーバー内のファイル名を指定し、それをWebページテンプレートにすると任意のファイルが出力される可能性がある(URLなど)
- ファイル名にディレクトリを含まないようにして固定ディレクトリを指定
    - 絶対パス・相対パスを表示しない
    - 固定ディレクトリの利用で絶対パスの指定を回避
    - 相対パスの指定はAPIで回避

#### 保険的対策

- サーバー内のファイル権限を正しく設定
- ファイル名のチェック
    - OSのパス名解釈できる../や\、URLエンコードした%2Fなどの文字列は処理しないようチェックをかける

---

### セッション管理の不備

#### 概要

- 利用者識別のためのセッションIDが不正取得される(推測や盗用など)
- なりすましや盗聴などの被害
- 攻撃者のセッションIDを使わされる(Session Fixation)という手口も

#### 根本的解決

- セッションIDを予測困難なものにする(推測からの回避)
    - 時刻情報などを基にしたアルゴリズムではなく、暗号論的擬似乱数生成器などを用いる
    - セッション管理の仕組みが提供されるWebアプリケーションを利用する場合は自前でセッション管理の仕組みを構築する必要はない
- セッションIDはURLパラメータに格納しない
    - 盗聴されるとセッションハイジャックされる
    - CookieかPOSTメソッドのhiddenパラメータの中にIDを入れるべし
    - Cookieブロックをユーザーがしている場合は自動でURLに切り替えが起こらないようにする
- HTTPSのCookieはsecure属性を加える
    - secure属性を加えるとHTTPSのみで利用される
    - HTTPでCookieを利用する場合はHTTPSとは別のものにする
- ログイン後に新しくセッションを開始する
    - セッションID固定化攻撃に対して脆弱であることを避ける
    - ログインが成功した時点から新しいセッションを開始する
    - ログイン前の既存のセッションIDは無効にする
- セッションIDとは別に秘密情報を発行しページごとにチェックをかける
    - ログイン後にセッションIDを新規に発行する場合は不要
    - 秘密情報をCookieにセットしてページごとにCookieと秘密情報が合致してるかを確認
    - 秘密情報の生成は暗号器を使う

#### 保険的対策

- セッションIDを固定値にしない
- セッションIDをCookieにセットする場合有効期限設定に注意
    - ブラウザに残す場合は有効期限を短めに設定して必要以上の期間Cookieがブラウザに保存されないようにする(盗難防止)
    - 有効期限を設定せずブラウザ終了時に破棄させるという方法もある
        - ブラウザを終了しないとダメなので場合によっては注意が必要

---

### クロスサイト・スクリプティング

#### 概要

- 利用者の入力フォームに<script></script>のようにスクリプトを埋め込むことで偽ページの表示やスクリプトの実行、Cookieの漏洩などが起こりうる

#### 対策

- HTMLテキストの入力を許可しない場合の対策
- HTMLテキストの入力を許可する場合の対策
- 全てのWebアプリケーションに共通の対策

##### HTMLテキストの入力を許可しない場合の対策

###### 根本的解決

- Webページに出力する全ての要素に対してエスケープ処理を施す
    - Webページの表示に影響する記号文字をHTMLエンティティに
    - タグは出力内の属性値を""でくくり、""内のダブルクォートはHTMLエンティティに
    - JavaScriptやinnerHTMLを使って動的にWebページの内容を変更していく場合も同様

- URLはhttpかhttpsのみを許可
    - javascript:で始まるURLはXSSの可能性がある
    - httpかhttpsのホワイトリストで実装すべき

- <script></script>を動的に生成しない
    - 外部入力依存で動的にscriptを生成すると危険なスクリプトが実行されてしまう可能性がある

- スタイルシートは外部から指定可能にしない
    - スタイルシートはexpression()などでスクリプトの記述が可能

###### 保険的対策

- 入力値の内容チェック
    - 仕様に沿うもののみを通す
    - 効果は限定的

##### HTMLテキストの入力を許可する場合の対策

###### 根本的解決

- 入力されたHTMLテキストから構文解析木を作成し、スクリプトを含まない必要な要素のみを抽出
    - ホワイトリスト方式
    - コーディングが複雑、高負荷な処理

###### 保険的対策

- 入力からスクリプトに該当する文字列を排除
    - 文字列に適当な文字を付加するなど
      - 付加した結果や削除した結果危険なものにもなりうることに注意
    - ブラックリスト方式は完全に対策できるわけではない

##### 全てのWebアプリケーションに共通の対策

###### 根本的解決

- HTTPレスポンスヘッダのContent-Typeフィールドに文字コードを指定
    - 一部の文字コードにブラウザが自動変換することでスクリプトが実行されうる
    - Content-Type: text/html; charset=UTF-8みたいな
    - 必ず指定すべき

###### 保険的対策

- Cookie情報の漏洩対策として発行するCookieにHttpOnly属性を加え、TRACEメソッドを無効化する
    - HttpOnly属性を加えるとHTMLテキスト内のスクリプトからのアクセスが禁止される
    - Set-Cookie:hoge HttpOnly
    - 全てのブラウザで機能するわけではない

- ブラウザのXSS対策機能を有効にするレスポンスヘッダを返す
    - ユーザーによって無効化されているかもしれないブラウザのXSSブロック機能をサーバー側から明示的な有効依頼のレスポンスヘッダを返す
    - ブラウザによっては対応状況に差がある

---

### CSRF(クロスサイト・リクエスト・フォージェリ)

#### 概要

- Webサイトへのログイン後、利用者からのリクエストが意図したものであるかどうかをチェックしない仕組みに由来する脆弱性
- 攻撃者の用意した罠により利用者が予期しない処理(送金、商品購入、退会、管理設定の不正変更など)を実行させられる可能性がある
- Cookieによるセッション管理やBasic認証、SSLクライアント認証などを実装しているとCSRFの攻撃を受ける可能性がある

#### 根本的解決

- 処理を実行するページをPOSTメソッドでアクセスするようにする
    - GETメソッドだと外部サイトに送信されるRefererに秘密情報が含まれてしまう
- 秘密情報はhiddenパラメータに保持されるよう前のページで自動生成し、実行ページでその値と照合する
    - 秘密情報をhiddenパラメータに出力
    - セッションIDを用いたり、セッションIDとは別のIDをログイン時に生成する
    - 確認画面から登録処理のリクエストを受けた際にはhiddenパラメータの値と秘密情報を照合し一致した場合のみ登録処理を行う
    - 攻撃者は秘密情報を入手できない限り攻撃できない
- Refererが正しいリンク元かを確認する
    - Refererが空だったり、不正な画面推移である場合は処理を実行しない
    - ただし、Webサイトによっては罠が設置できてしまったりする
    - ファイヤウォールなどでRefererを空にしているユーザーはサービスが利用できなかったりすることも注意

#### 保険的対策

- 重要な操作を行なった場合はそのことを登録済みメールアドレスに自動送信する
    - 攻撃を防ぐわけではないが異変に気づくきっかけにはなる
    - メール本文にプライバシーに関わる情報を入れないようにする

---

### HTTPヘッダ・インジェクション

#### 概要

- リクエストに対して出力するHTTPレスポンスヘッダのフィールド値を外部入力で動的生成する際、レスポンスヘッダの出力処理に問題がある
- レスポンス内容に任意のヘッダフィールドやボディ、複数のレスポンスを作り出せてしまう
- Cookie情報の漏洩などが起こりうる
- 複数のレスポンスを作り出す攻撃はHTTPレスポンス分割攻撃と呼ぶ
- XSSと同じような被害やキャッシュサーバーの汚染影響がある
- リバースプロキシとしてキャッシュサーバーを構築している場合は注意が必要

#### 根本的解決

- ヘッダの出力は直接ではなくWebアプリケーションの実行環境や言語に用意されているヘッダ出力用APIを利用
    - Content-Typeフィールドなど、直接プログラムで出力するものは使わない
    - フィールド値に式の値をそのまま出力すると改行コードなどを与えられた際にHTTPヘッダが改行などで区切られて任意のヘッダフィールドやボディ、複数のレスポンスなどの影響が起こりうる
    - 実行環境によってはAPIが改行コードなどを適切に処理しない脆弱性もあるので別の対策を取るべき
- APIを利用できない場合、改行を許可しないように実装する

#### 保険的対策

- 外部からの入力のすべてについて改行コードを削除する
    - アプリケーションによっては改行コードを含みうる文字列を受け取る必要があり、アプリケーションが正しく動作しなくなる可能性がある

---

### メールヘッダ・インジェクション

#### 概要

- メールフォームなどに問題がある場合、Webサイトの管理者が設定した固定のメールアドレスでない宛先にメールを送信されうる
- 迷惑メールの送信に悪用される可能性など

#### 根本的解決

- メールヘッダを固定値にして外部からの入力は全てメール本文に出力
    - 外部から与えられた改行コードが余分な改行として差し込まれないようにする
    - To, Cc, Bcc, Subjectなどは固定にする
    - メール送信プログラムへの出力処理にも注意
- メールヘッダを固定値にできない場合、Webアプリケーションの実行環境や言語に用意されているメール送信用APIを使用する
    - APIによっては改行コードの取り扱いに脆弱性があるものがあるので注意
    - 改行コードの後に空白か水平タブを入れることで継続行として処理する方法など、改行を許可しない処理も必要
- HTMLで宛先を指定しない
    - 論外の実装
    - hiddenパラメータなどに宛先をそのまま指定するとパラメータの改変によりメールシステムの第三者中継につながる可能性がある

#### 保険的対策

- 外部からの入力の全てについて改行コードを削除する
    - 前と同じ

---

### クリックジャッキング

#### 概要

- iframeでサイトを透明に表示させるようにし、罠サイトのみが表示されているようにする
- ログインなどの機能がマウス操作のみ可能な場合、細工された外部サイトの閲覧と操作で意図しない処理が行われる可能性がある
- ログイン後の利用者のみが利用・設定可能なコンテンツが変更・悪用されうる

#### 根本的解決

- HTTPレスポンスヘッダにX-Frame-Optionsヘッダフィールドを出力し、他ドメインサイトからのframe要素やiframe要素による読み込みを制限する
    - X-Frame-Optionsによってクリックジャッキング攻撃から防御する
    - X-Frame-Options:DENYのようにHTTPレスポンスヘッダに出力する
    - IE7では利用できない
- 処理実行前のぺ0時で再度パスワードの入力を求めて、実行ページで照合
    - 画面設計の仕様変更を要する対策

#### 保険的対策

- 重要な処理はマウスのみで実行できないようにする

---

### バッファオーバーフロー

#### 概要

- 確保されたメモリ領域を超えた上書きがされると意図しないコードの実行が行われうる
- サービスの停止、ウイルス、ワーム、ボットへの感染など

#### 根本的解決

- 直接メモリにアクセスできない言語で記述する
    - PHP, Perl, Javaなどを使う
- 直接メモリにアクセスできる言語の記述部分を最小にする
- 脆弱性が修正されたバージョンのライブラリを使用する

---

### アクセス制御や認可制御の欠落

- 運営者のセキュリティに対する認識のなさから不適切な設計で作成されたWebサイトが運用されているとき

#### アクセス制御の欠落

##### 根本的解決

- アクセス制御機能による防御措置が必要とされるWebサイトにはパスワードなどの秘密情報の入力を必要とする認証機能を設ける

#### 認可制御の欠落

##### 根本的解決

- 認証機能に加えて認可制御の処理を実装し、ログイン中の利用者が他人になりすましできないようにする
    - 利用者ごとにセッションIDを与えセッション管理を行い、アクセスごとにセッションIDからセッション変数などを介して利用者IDを取得できるようにすれば良い
        - 利用者IDをキーとしてデータベースを扱う
    - 利用者IDをURLやPOSTパラメータに埋め込んでいる画面が存在する
        - 外部から与えられる利用者IDをキーにしてデータベースが操作できる実装になっているとログイン中の利用者が他の利用者になりすまして操作できてしまう
        - データベースを検索するための利用者IDがログイン中の利用者IDと一致しているかを確認する実装や、利用者IDを外部パラメータではなくセッション変数から取得する実装にする

---

## Webサイトの安全性向上について

- 安全性向上に向けた取り組み
- 設計・実装レベルではなく運用レベルのお話

---

### Webサーバーに関する対策

- OSやソフトウェアの脆弱性情報を継続的に入手して脆弱性への対処を行う
- リモートでWeb操作を行う場合はパスワード認証以外の方法(SSHなど)を検討する
- パスワード認証の場合は総当りできないくらい複雑にする
- 不要なサービスまたはアカウントを停止または削除する
    - サービスに対する管理が十分でなく、脆弱性が存在するパーミッションをそのまま利用している可能性が考えられるため
    - 用途が明確でないユーザーアカウントが存在している場合、そのアカウントに対する管理が十分ではなく不正利用される可能性が考えられる
- 公開を想定していないファイルをWeb公開用のディレクトリ以下に置かない
    - Web公開用のディレクトリに保管されているファイル群は基本的に外部から閲覧可能
    - リンクがなくても外部からの指定で閲覧できてしまう

---

### DNSに関する対策

- ドメイン名およびそのDNSサーバーの登録状況を調査し、必要に応じて対処を行う
    - 問題のある運用や設定がなされているドメインおよびそのDNSサーバーは乗っ取りにつながる可能性がある
    - DNSソフトウェアの更新や設定を見直す
        - DNSを狙った攻撃・・・キャッシュポイズニングやリフレクター、水責め攻撃など
        - ソフトウェアの設定不備や古いバージョンでキャッシュポイズニングを受けやすくなる
        - 同様にリフレクター攻撃や水責め攻撃の踏み台に悪用される可能性が高まる
        - ソフトウェア自体の脆弱性(DNSサーバーの異常終了につながる)にもあるので定期的に更新するべき

---

### ネットワーク盗聴への対策

- 重要な情報を扱うWebページでは通信経路を暗号化する
    - SSL(Secure Socket Layer)やTLS(Transport Layer Security)を用いたHTTPS通信で通信を暗号化する
    - 入力画面が盗聴者に改竄される可能性があるので入力画面でもhttps://のURLにしておく必要がある
        - 改竄されると、差し替えられた別のサイトに送信されてしまったり盗聴される危険性がある
    - 利用者がhttp://で秘密情報を入力してしまうことを防止するためのHSTS(HTTP Strict Transport Security)の機能がある
        - 機能を有効にするためにはWebサイト側で指定する必要がある
        - WebサーバーのレスポンスヘッダにStrict-Transport-Securityを含める
        - 一度そのサイトを訪れたブラウザはそれ以降https://でしか接続しないようになる
        - 機能を利用するにはサイト全体をhttps://の画面にするよう設計する必要がある
        - ログイン中のセッションすべてでHTTPS
        - セッション管理に用いるセッションIDを格納するCookieにはSecure属性を加える

- 利用者へ通知する重要情報はメールで送らず暗号化されたhttps://のページに表示する
    - 暗号化が必要な重要情報は盗聴を回避するためにWebページ上で表示すべき
- Webサイト運営者がメールで受け取る重要情報を暗号化する
    - Webサイト管理者がWebアプリケーション経由でWeb入力された個人情報を受け取るときはS/MIMEやPGPを使ってメール本文を暗号化する
        - S/MIME(Secure/Multipurpose Internet Mail Extensions)やPGP(Pretty Good Privacy)などの技術は暗号化環境や秘密鍵が必要なため、この場合は使えても利用者側にメール送信する場合には現実的でない手法となる

---

### フィッシング詐欺を助長しないための対策

- EV SSL証明書を取得し、サイトの運営者が誰であるかを証明する
    - HTTPSアクセス時にブラウザのアドレスが緑色で表示されて誰が運営者かを利用者が確認できる
    - クレジットカード番号やパスワードなど秘密情報を入力する際の安全性が高まる
- フレームを利用する場合、子フレームのURLを外部パラメータから生成しないよう実装する
    - 子フレームのURLを外部パラメータから生成するとフィッシング詐欺に悪用される危険性がある
    - リンクを攻撃者によって仕掛けられた場合、アクセスした利用者は本物サイトの親フレーム内に偽サイトのWebページを子フレームとして埋め込まれた画面を閲覧してしまう(その上、ドメインは親サイトの本物のドメインであるため判別不可能)
- 利用者がログイン後に移動するページをリダイレクト機能で動的に実装しているWebサイトは、リダイレクト先のURLとして使用されるパラメータの値には自サイトのドメインのみを許可する
    - ちょっと後でもう一回読む

---

### パスワードに関する対策

- 初期パスワードは推測が困難な文字列で発行する
    - 暗号論的擬似乱数生成器を使いできれば長い文字列にする
    - 複数のユーザー登録で規則性を見破られる可能性があるので規則性のあるアルゴリズムは利用しない
- パスワード変更には現行パスワードの入力を求める
- 入力後の応答メッセージが認証情報の推測のヒントとならない工夫をする
    - 「パスワードが間違っています」だとユーザーID割り出しが容易になってしまう
- 入力フィールドではパスワードは伏字で表示されるようにする
- パスワードをサーバー内で保管するときは平文ではなくソルトつきハッシュ値の形で保管する
    - 保管していたパスワードはSQLインジェクションなどで漏洩する可能性がある
    - 万一パスワード情報が漏洩した場合でも直ちに悪用されることの内容にパスワードを保護した形で保管する
    - 一般的にはハッシュ値の形で保管
    - パスワードにソルトというユーザーごとに異なる文字列をつけてからハッシュ値を求めるものとすることで見かけ上のパスワードを長くできる
        - レインボーテーブル(総当りを高速化する技術)を回避できる
        - 同じユーザーの別サイトでの同一のパスワードの発見を防止
    - ハッシュ値をさらにハッシュする(ストレッチング)

---

### WAFによるWebアプリケーションの保護

#### 概要

- WAF(Web Application Firewall)で脆弱性攻撃そのものからアプリケーションを保護する運用面での対策
- アプリケーションと利用者でのHTTP(またはHTTPS)通信を検査し攻撃など不正な通信を自動的に遮断する
- ハードウェア、ソフトウェアがあり、複数のアプリケーションへの攻撃をまとめて防御できる

#### WAFの使用が有効な状況

- 脆弱性を作り込まないように開発すべきだが、開発が終わった後に脆弱性が発見される時もある
- 修正が困難な場合はWAFが攻撃による影響低減に貢献する
    - 開発者に改修・修正が依頼できない状況など
    - 改修できないWebアプリケーションに脆弱性が発見された状況
        - オープンソースや商用製品を利用している場合
        - パッチが提供されないと脆弱性は修正できない
        - サポート期間が終了している場合など

#### WAFのHTTP通信の検査

- WAFを導入したWebサイト運営者が設定する検出パターンに基づいてHTTP通信内のHTTPリクエスト、レスポンスそれぞれの中身を機械的に検出する
- 検出パターンには脆弱性攻撃の可能性が高い文字列や仕様で定義されているパラメータの型、値など
- 陰性(正常)判定ならばそのまま送信する
- 陽性(悪質)判定ならば該当通信の遮断と管理者への警告を行う

##### 判定エラー

- 偽陽性...判定基準が幅広いパターンに一致してしまうことで正常なユーザーの利用もブロックしてしまう
- 偽陰性...判定基準が緩いために悪質なHTTPリクエストも送信してしまう
- 検出パターンに頼った判定のため、安全性と利便性のトレードオフが生じる

---

### 携帯Web向けのサイトにおける注意点

- 今までの対策に加えての話
- PC向けとはまた違ったサイト設計が必要になる場合

#### セッション管理に関する注意点

- CookieとReferer非対応の機種と対応の機種が混在することによる
- セッションIDをCookieではなくURLに格納せざるを得ない場合、Referer機能でセッションIDの含まれたURLをリンク先のサイトに送信することでセッションハイジャックが起こりうる
- 利用者が自らURLを公開してしまうことで検索エンジンに登録され個人情報漏洩の危険がある
- 機種ごとに実装方法を変えるべき

#### クロスサイトスクリプティングに関する注意点

- JavaScriptに対応する機種が増えてきたことで、PCサイトと同様にXSS対策が必要になった

#### 携帯IDに関する注意点

##### 携帯IDとは

- Webサイトを閲覧する際に端末や契約者ごとに割り振られた携帯番号の識別子
- 全てのWebサイトに同じ携帯IDが通知される
- HTTPリクエストヘッダ(User-Agentヘッダかキャリア独自の拡張ヘッダ)に格納されWebサイトに通知される
- 設定変更で通知を停止することもできる

##### 携帯IDによる脆弱な認証

- 携帯IDだけを認証とする設計は近年成り立たなくなってきた
- パスワードやCookieなどを利用したPC向けサイトと同様の認証方式を採用するかキャリアが提供する安全な認証方式を採用するべき

##### 認証情報に関する注意点

- 秘密情報でない情報(生年月日など)を認証情報として使用しない
- 試行錯誤回数を制限する方式が確実には取れないので4桁パスワードを利用せず英数字を織り交ぜた桁数の多いパスワードを使用させる

##### 利便性との両立

- パターン数を確保したまま入力頻度を減らす設計
- Cookie機能を用いて一定期間有効なセッションIDを発行するなど

---

失敗例は省略
