# 安全なWebサイトの作り方まとめ

IPA「安全なWebサイトの作り方」の個人的まとめ
link: https://www.ipa.go.jp/security/vuln/websecurity.html

## Webアプリケーションのセキュリティ実装

### SQLインジェクション

#### 概要

- SQL文の組み立てに問題がある場合の攻撃
- データベースの不正利用を招く可能性がある

#### 根本的解決

-  プレースホルダでSQL組み立てを実装する
    - アプリケーションで直接文字列連結処理は回避
    - SQLの雛形に変数のポインタを置き、実際の値をそこに割り当てる(バインド
    - 静的プレースホルダと動的プレースホルダがある
    - 静的の方だとSQLインジェクション自体がなくなる
- 文字列連結の場合はエスケープ処理でSQL文のリテラルを正しく構成
    - 数値型へのキャストや’\などの特殊記号文字をエスケープ
- アプリケーションに渡されるパラメータにSQL文を直接指定しない
    - hiddenパラメータにSQLをそのまま指定するなどは論外
    - パラメータの改変によりデータベースの不正利用がありうる

#### 保険的対策

- エラーメッセージをそのままブラウザに表示しない
    - SQLインジェクションのヒントになってしまう
- データベースアカウントへの適切な権限assign
    - 命令実行に必要な最低限の権限をアカウントに与える

### OSコマンド・インジェクション

#### 概要

- OSコマンドを含む攻撃によりサーバー上でOSコマンドが不正に実行される
- 重要情報の漏えいやシステム不正操作のほか、他の攻撃への踏み台にされうる

#### 根本的解決

- シェルを起動できる言語機能の利用を避ける
    - 外部からの入力値を引数にOSコマンドを実行できる機能(シェル起動)を避ける
    - Perlなどの場合sysopen関数を利用するなどでシェル起動を避ける

#### 保険的対策

- シェル起動を含む言語機能を利用する場合は引数をチェック
    - 入力されうる引数のホワイトリストを作る
    - 想定動作以外のコマンドを処理しない

### ディレクトリ・トラバーサル

#### 概要

- パラメータにサーバー内のファイル名を直接指定している問題
- 攻撃者によって任意のファイルを指定され意図しない処理が行われうる
- 公開を想定していないファイルが閲覧されうるなどの被害

#### 根本的解決

- 外部からのパラメータでサーバー内のファイルを直接指定しない
    - HTML上のhiddenパラメータでサーバー内のファイル名を指定し、それをWebページテンプレートにすると任意のファイルが出力される可能性がある(URLなど)
- ファイル名にディレクトリを含まないようにして固定ディレクトリを指定
    - 絶対パス・相対パスを表示しない
    - 固定ディレクトリの利用で絶対パスの指定を回避
    - 相対パスの指定はAPIで回避

#### 保険的対策

- サーバー内のファイル権限を正しく設定
- ファイル名のチェック
    - OSのパス名解釈できる../や\、URLエンコードした%2Fなどの文字列は処理しないようチェックをかける

### セッション管理の不備

#### 概要

- 利用者識別のためのセッションIDが不正取得される(推測や盗用など)
- なりすましや盗聴などの被害
- 攻撃者のセッションIDを使わされる(Session Fixation)という手口も

#### 根本的解決

- セッションIDを予測困難なものにする(推測からの回避)
    - 時刻情報などを基にしたアルゴリズムではなく、暗号論的擬似乱数生成器などを用いる
    - セッション管理の仕組みが提供されるWebアプリケーションを利用する場合は自前でセッション管理の仕組みを構築する必要はない
- セッションIDはURLパラメータに格納しない
    - 盗聴されるとセッションハイジャックされる
    - CookieかPOSTメソッドのhiddenパラメータの中にIDを入れるべし
    - Cookieブロックをユーザーがしている場合は自動でURLに切り替えが起こらないようにする
- HTTPSのCookieはsecure属性を加える
    - secure属性を加えるとHTTPSのみで利用される
    - HTTPでCookieを利用する場合はHTTPSとは別のものにする
- ログイン後に新しくセッションを開始する
    - セッションID固定化攻撃に対して脆弱であることを避ける
    - ログインが成功した時点から新しいセッションを開始する
    - ログイン前の既存のセッションIDは無効にする
- セッションIDとは別に秘密情報を発行しページごとにチェックをかける
    - ログイン後にセッションIDを新規に発行する場合は不要
    - 秘密情報をCookieにセットしてページごとにCookieと秘密情報が合致してるかを確認
    - 秘密情報の生成は暗号器を使う

#### 保険的対策

- セッションIDを固定値にしない
- セッションIDをCookieにセットする場合有効期限設定に注意
    - ブラウザに残す場合は有効期限を短めに設定して必要以上の期間Cookieがブラウザに保存されないようにする(盗難防止)
    - 有効期限を設定せずブラウザ終了時に破棄させるという方法もある
        - ブラウザを終了しないとダメなので場合によっては注意が必要

### クロスサイト・スクリプティング

#### 概要

- 利用者の入力フォームに<script>hoge</script>のようにスクリプトを埋め込むことで偽ページの表示やスクリプトの実行、Cookieの漏洩などが起こりうる

#### 対策

- HTMLテキストの入力を許可しない場合の対策
- HTMLテキストの入力を許可する場合の対策
- 全てのWebアプリケーションに共通の対策

##### HTMLテキストの入力を許可しない場合の対策

###### 根本的解決

- Webページに出力する全ての要素に対してエスケープ処理を施す
    - Webページの表示に影響する記号文字をHTMLエンティティに
    - タグは出力内の属性値を""でくくり、""内のダブルクォートはHTMLエンティティに
    - JavaScriptやinnerHTMLを使って動的にWebページの内容を変更していく場合も同様

- URLはhttpかhttpsのみを許可
    - javascript:で始まるURLはXSSの可能性がある
    - httpかhttpsのホワイトリストで実装すべき

- <script></script>を動的に生成しない
    - 外部入力依存で動的にscriptを生成すると危険なスクリプトが実行されてしまう可能性がある

- スタイルシートは外部から指定可能にしない
    - スタイルシートはexpression()などでスクリプトの記述が可能

###### 保険的対策

- 入力値の内容チェック
    - 仕様に沿うもののみを通す
    - 効果は限定的

##### HTMLテキストの入力を許可する場合の対策

###### 根本的解決

- 入力されたHTMLテキストから構文解析木を作成し、スクリプトを含まない必要な要素のみを抽出
    - ホワイトリスト方式
    - コーディングが複雑、高負荷な処理

###### 保険的対策

- 入力からスクリプトに該当する文字列を排除
    - 文字列に適当な文字を付加するなど
      - 付加した結果や削除した結果危険なものにもなりうることに注意
    - ブラックリスト方式は完全に対策できるわけではない

##### 全てのWebアプリケーションに共通の対策

###### 根本的解決

- HTTPレスポンスヘッダのContent-Typeフィールドに文字コードを指定
    - 一部の文字コードにブラウザが自動変換することでスクリプトが実行されうる
    - Content-Type: text/html; charset=UTF-8みたいな
    - 必ず指定すべき

###### 保険的対策

- Cookie情報の漏洩対策として発行するCookieにHttpOnly属性を加え、TRACEメソッドを無効化する
    - HttpOnly属性を加えるとHTMLテキスト内のスクリプトからのアクセスが禁止される
    - Set-Cookie:hoge HttpOnly
    - 全てのブラウザで機能するわけではない

- ブラウザのXSS対策機能を有効にするレスポンスヘッダを返す
    - ユーザーによって無効化されているかもしれないブラウザのXSSブロック機能をサーバー側から明示的な有効依頼のレスポンスヘッダを返す
    - ブラウザによっては対応状況に差がある

### CSRF(クロスサイト・リクエスト・フォージェリ)





## Webサイトの安全性向上について
